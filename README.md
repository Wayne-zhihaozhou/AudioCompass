# AudioCompass

**AudioCompass** 是一个基于声音分析的实时声源定位系统，能够通过捕获系统音频或麦克风输入，实现“听声辨位”，并将声源方向用可视化方式显示在屏幕上。

---

## 功能特性

- **实时音频捕获**  
  使用 WASAPI Loopback 技术捕获系统音频或麦克风输入，返回 PCM 数据流。

- **高频事件检测**  
  通过 FFT 分析音频频谱，检测高频内容并过滤低频噪音。高频事件触发后会进行声源方向分析。

- **声源方向计算**  
  根据左右声道能量差计算声源方位角度，范围 ±90°。差异越大，角度越偏向能量更强的一侧。

- **动态残影可视化**  
  使用透明叠加窗口显示实时弧形和残影轨迹，残影持续时间根据角度动态调整，角度越大残影时间越长。

- **文字显示**  
  在叠加窗口显示当前角度，字体和颜色可配置。

- **音频数据保存**  
  将高频事件对应的 PCM 数据流式写入 WAV 文件，用于后续分析或模型训练。

- **用户可配置**  
  - 高频检测阈值、比率  
  - 残影基础时间 (`trailBaseDuration`) 和最大持续时间 (`trailMaxDuration`)  
  - 弧形颜色 (`liveColor`) 和残影颜色 (`trailColor`)  
  - 文字颜色 (`textColor`)  
  - 声源角度阈值 (`trailAngleThreshold`)

---

## 项目实现原理

1. **音频捕获与处理**  
   - 使用 WASAPI Loopback 捕获系统音频流。  
   - 将多声道音频转换为单声道进行 FFT 分析，用于高频检测。  
   - 高频事件触发后，将 PCM 数据推送到分析线程和保存线程。

2. **FFT 分析与高频判定**  
   - 将采样数据做简单傅里叶变换（`simpleFFT()`）。  
   - 统计指定高频段能量占比，判断是否触发音频事件。

3. **声源方位计算**  
   - 根据左右声道 RMS 能量差计算分贝差 (`dbDiff`)。  
   - 将分贝差映射到 ±90° 范围，实现声源方位角度。  

4. **透明叠加窗口显示**  
   - 使用 GDI+ 创建半透明 Bitmap。  
   - 利用 `UpdateLayeredWindow()` 将 Bitmap 渲染到屏幕上，创建可叠加的动态界面。  
   - 实时弧形显示当前声源方向，残影显示历史音频事件轨迹。  
   - 残影持续时间根据角度动态调整：


5. **音频数据保存**  
   - 高频事件 PCM 数据流式写入 WAV 文件。  
   - 保存线程与捕获线程并行运行，保证实时性。

---

## 技术路线

1. **音频层**  
   WASAPI Loopback / 麦克风输入 → PCM 数据捕获 → 高频事件检测 → 数据队列（分析线程、保存线程）

2. **分析层**  
   FFT 频谱分析 → 高频判定 → 左右声道 RMS → 方位角计算

3. **可视化层**  
   Canvas 类 + GDI+ → 透明叠加窗口 → 实时弧形 + 残影显示 → 文字显示角度

4. **线程与并发**  
   - 捕获线程：循环读取音频缓冲  
   - 分析线程：处理高频事件和角度计算  
   - 保存线程：流式写入 WAV  
   - 使用 `std::mutex` + `std::condition_variable` 保证队列并发安全

5. **用户配置**  
   提供接口调节残影时间、颜色、阈值等参数，满足不同应用需求

---

## 项目亮点

- 实时性高，延迟低  
- 可视化直观，弧形 + 残影轨迹显示声源方向  
- 用户可配置性强  
- 高频事件音频可保存，用于后续分析或模型训练

---

## 以 PUBG 游戏作为示例演示(待补充)

